#! /bin/bash

source .env

docker compose push

if ! docker buildx ls | grep -q uberbase-local-docker-container; then
  docker buildx create --name uberbase-local-docker-container --use
fi

docker buildx build \
  --platform linux/amd64,linux/arm64 \
  --build-arg="UBERBASE_DOMAIN=$UBERBASE_DOMAIN" \
  --build-arg="UBERBASE_ADMIN_USERNAME=$UBERBASE_ADMIN_USERNAME" \
  --build-arg="UBERBASE_ADMIN_EMAIL=$UBERBASE_ADMIN_EMAIL" \
  --build-arg="UBERBASE_ADMIN_PASSWORD=$UBERBASE_ADMIN_PASSWORD" \
  --build-arg="UBERBASE_TRAEFIK_STORAGE=$UBERBASE_TRAEFIK_STORAGE" \
  --build-arg="UBERBASE_REDIS_HOST=$UBERBASE_REDIS_HOST" \
  --build-arg="UBERBASE_REDIS_PORT=$UBERBASE_REDIS_PORT" \
  --build-arg="UBERBASE_REDIS_SECRET=$UBERBASE_REDIS_SECRET" \
  --build-arg="UBERBASE_REDIS_STORAGE=$UBERBASE_REDIS_STORAGE" \
  --build-arg="UBERBASE_POSTGRES_HOST=$UBERBASE_POSTGRES_HOST" \
  --build-arg="UBERBASE_POSTGRES_DATABASE=$UBERBASE_POSTGRES_DATABASE" \
  --build-arg="UBERBASE_POSTGRES_USER=$UBERBASE_POSTGRES_USER" \
  --build-arg="UBERBASE_POSTGRES_PASSWORD=$UBERBASE_POSTGRES_PASSWORD" \
  --build-arg="UBERBASE_POSTGRES_PORT=$UBERBASE_POSTGRES_PORT" \
  --build-arg="UBERBASE_POSTGRES_STORAGE=$UBERBASE_POSTGRES_STORAGE" \
  --build-arg="UBERBASE_POSTGREST_VERSION=$UBERBASE_POSTGRES_VERSION" \
  --build-arg="UBERBASE_POSTGREST_JWT_SECRET=$UBERBASE_POSTGRES_JWT_SECRET" \
  --build-arg="UBERBASE_POSTGREST_PORT=$UBERBASE_POSTGREST_PORT" \
  --build-arg="UBERBASE_MINIO_HOST=$UBERBASE_MINIO_HOST" \
  --build-arg="UBERBASE_MINIO_PORT=$UBERBASE_MINIO_PORT" \
  --build-arg="UBERBASE_MINIO_CONSOLE_PORT=$UBERBASE_MINIO_CONSOLE_PORT" \
  --build-arg="UBERBASE_MINIO_STORAGE=$UBERBASE_MINIO_STORAGE" \
  --build-arg="UBERBASE_MINIO_ROOT_USER=$UBERBASE_MINIO_ROOT_USER" \
  --build-arg="UBERBASE_MINIO_ROOT_PASSWORD=$UBERBASE_MINIO_ROOT_PASSWORD" \
  --build-arg="UBERBASE_FUSIONAUTH_DATABASE=$UBERBASE_FUSIONAUTH_DATABASE" \
  --build-arg="UBERBASE_FUSIONAUTH_DATABASE_USERNAME=$UBERBASE_FUSIONAUTH_DATABASE_USERNAME" \
  --build-arg="UBERBASE_FUSIONAUTH_DATABASE_PASSWORD=$UBERBASE_FUSIONAUTH_DATABASE_PASSWORD" \
  --build-arg="UBERBASE_FUSIONAUTH_APP_MEMORY=$UBERBASE_FUSIONAUTH_APP_MEMORY" \
  --build-arg="UBERBASE_FUSIONAUTH_APP_RUNTIME_MODE=$UBERBASE_FUSIONAUTH_APP_RUNTIME_MODE" \
  --build-arg="UBERBASE_FUSIONAUTH_PORT=$UBERBASE_FUSIONAUTH_PORT" \
  --build-arg="UBERBASE_FUSIONAUTH_APP_URL=$UBERBASE_FUSIONAUTH_APP_URL" \
  --build-arg="UBERBASE_FUSIONAUTH_STORAGE=$UBERBASE_FUSIONAUTH_STORAGE" \
  --build-arg="UBERBASE_FUNCTIONS_PORT=$UBERBASE_FUNCTIONS_PORT" \
  --build-arg="UBERBASE_FUNCTIONS_IMAGE_PATH=$UBERBASE_FUNCTIONS_IMAGE_PATH" \
  --build-arg="UBERBASE_VAULT_HOST=$UBERBASE_VAULT_HOST" \
  --build-arg="UBERBASE_VAULT_PORT=$UBERBASE_VAULT_PORT" \
  --build-arg="UBERBASE_VAULT_STORAGE=$UBERBASE_VAULT_STORAGE" \
  --build-arg="UBERBASE_REGISTRY_STORAGE=$UBERBASE_REGISTRY_STORAGE" \
  --build-arg="UBERBASE_REGISTRY_PORT=$UBERBASE_REGISTRY_PORT" \
  --build-arg="UBERBASE_REGISTRY_USERNAME=$UBERBASE_REGISTRY_USERNAME" \
  --build-arg="UBERBASE_REGISTRY_PASSWORD=$UBERBASE_REGISTRY_PASSWORD" \
  --target uberbase \
  --no-cache \
  --push \
  -t bluetongueai/uberbase:latest \
  --provenance=true --sbom=true \
  .
