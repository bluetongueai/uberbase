#! /bin/bash

podman pull ghcr.io/basecamp/kamal:latest

./bin/configure

echo "Running kamal..."

if [[ ${SSH_AUTH_SOCK} == "/run/host-services/ssh-auth.sock" ]]; then
  echo "Running kamal on MacOS host" >&2
  podman run --rm \
    -e "SSH_AUTH_SOCK=/run/host-services/ssh-auth.sock" \
    -v "/run/host-services/ssh-auth.sock:/run/host-services/ssh-auth.sock" \
    -v "/var/run/docker.sock:/var/run/docker.sock" \
    -v "/home/podman/kamal:/workdir" \
    -v "${PWD}/_configs/kamal:/workdir/config" \
    ghcr.io/basecamp/kamal:latest $@
else
  echo "Running kamal on Linux host" >&2
  podman run --rm \
    -e "SSH_AUTH_SOCK=/ssh-agent" \
    -v "${SSH_AUTH_SOCK}:/ssh-agent" \
    -v "/var/run/docker.sock:/var/run/docker.sock" \
    -v "/home/podman/kamal:/workdir" \
    -v "${PWD}/_configs/kamal:/workdir/config" \
    ghcr.io/basecamp/kamal:latest $@
fi


