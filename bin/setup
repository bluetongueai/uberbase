#! /bin/bash
shopt -s expand_aliases

# first, check if we're on linux or mac
platform=$(uname)

if [[ $platform == 'Linux' ]]; then
  echo -e "\033[33mLinux detected\033[0m"
  echo -e "\033[33mChecking for containerd...\033[0m"
  if test ! $(which containerd); then
    echo -e "\033[33m installing...\033[0m"
    sudo apt-get update
    sudo apt-get install -y containerd
    sudo nerdctl run --privileged --rm tonistiigi/binfmt:master --install all
  else
    echo -e "\033[32m found\033[0m"
  fi

  echo -e "\033[33mChecking for nerdctl...\033[0m"
  if test ! $(which nerdctl); then
    echo -e "\033[33m installing...\033[0m"
    sudo apt-get update
    sudo apt-get install -y nerdctl
  else
    echo -e "\033[32m found\033[0m"
  fi

  echo -e "\033[32mReady\033[0m"
else
  echo -e "\033[33mMac detected\033[0m"
  echo -e "\033[33mChecking for homebrew...\033[0m"
  if test ! $(which brew); then
    echo -e "\033[33m installing...\033[0m"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  else
    echo -e "\033[32m found\033[0m"
  fi

  # check if lima is installed
  echo -e "\033[33mChecking for lima...\033[0m"
  if test ! $(which lima); then
    echo -e "\033[33m installing...\033[0m"
    brew install lima
  else
    echo -e "\033[32m found\033[0m"
  fi

  echo -e "\033[33mStarting lima VM\033[0m"
  limactl start default
  lima nerdctl run --privileged --rm tonistiigi/binfmt:master --install all

  alias nerdctl="lima nerdctl"
  echo -e "\033[33mnerdctl aliased to "lima nerdctl"\033[0m"
  echo -e "\033[32mReady\033[0m"
fi
