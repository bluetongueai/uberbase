#! /bin/bash

#arch=$(uname -m)
#
#curl -LO https://github.com/firecracker-microvm/firecracker/releases/download/v1.7.0/firecracker-v1.7.0-$arch.tgz
#tar -xvzf firecracker-v1.7.0-$arch.tgz
#chmod +x release-v1.7.0-$arch/*
#sudo mv release-v1.7.0-$arch/* /usr/local/bin/.
#rm -Rf release-v1.7.0-$arch
#sudo ln -s /usr/local/bin/firecracker-v1.7.0-$arch /usr/local/bin/firecracker
#sudo ln -s /usr/local/bin/jailer-v1.7.0-$arch /usr/local/bin/jailer
#
#curl -LO https://github.com/containerd/nerdctl/releases/download/v2.0.0-rc.0/nerdctl-full-2.0.0-rc.0-linux-amd64.tar.gz
#sudo tar -xvzf nerdctl-full-2.0.0-rc.0-linux-amd64.tar.gz -C /usr/local
#

bin/configure

mkdir -p /var/lib/firecracker-containerd
mkdir -p /var/lib/firecracker-containerd/runtime
mkdir -p /var/lib/firecracker-containerd/snapshotter/devmapper

[ -e /var/lib/firecracker-containerd/runtime/hello-vmlinux.bin ] || curl -o /var/lib/firecracker-containerd/runtime/hello-vmlinux.bin https://s3.amazonaws.com/spec.ccfc.min/img/hello/kernel/hello-vmlinux.bin
[ -e /var/lib/firecracker-containerd/runtime/ubuntu-22.04.ext4 ] || curl -o /var/lib/firecracker-containerd/runtime/ubuntu-22.04.ext4 https://s3.amazonaws.com/spec.ccfc.min/firecracker-ci/v1.9/${ARCH}/ubuntu-22.04.ext4
[ -e /var/lib/firecracker-containerd/runtime/hello-id_rsa ] || curl -o /var/lib/firecracker-containerd/runtime/ubuntu-22.04.id_rsa https://s3.amazonaws.com/spec.ccfc.min/firecracker-ci/v1.9/${ARCH}/ubuntu-22.04.id_rsa

pushd /firecracker-containerd
sed -i 's/grep -Po/grep -Eo/g' Makefile
make all
make install
make firecracker
make install-firecracker
popd

pushd /nerdctl
curl -LO https://github.com/containerd/nerdctl/releases/download/v1.7.6/nerdctl-1.7.6-linux-amd64.tar.gz
tar -xf nerdctl-1.7.6-linux-amd64.tar.gz -C /usr/local/bin nerdctl
install -d /etc/nerdctl
rm /nerdctl/*
popd
