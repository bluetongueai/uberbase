#! /bin/bash

echo ""
echo "  __  _____  _______  ___  ___   ________"
echo " / / / / _ )/ __/ _ \/ _ )/ _ | / __/ __/"
echo "/ /_/ / _  / _// , _/ _  / __ |_\ \/ _/"  
echo "\____/____/___/_/|_/____/_/ |_/___/___/"  
echo ""
echo ""

platform=$(uname -m)
echo -e "Starting \033[33muberbase\033[0m..."
export UBERBASE_PLATFORM="`arch | sed s/arm64/aarch64/ | sed s/amd64/x86_64/`"
echo -e "Starting on \033[33m$UBERBASE_PLATFORM\033[0m"

mkdir -p ./data/vault_data
mkdir -p ./data/postgres_data

./bin/stop
./bin/configure
./bin/vault

# start postgres first, cause fusionauth is dumb and can't restart a db connection
PODMAN_COMPOSE_WARNING_LOGS=false podman-compose up postgres -d

# start the uberbase api, which starts the rest of the services
./functions/api/bin/api ./configs/functions/config.json 2>&1 | tee ./logs/uberbase.log
