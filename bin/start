#! /bin/bash

# define a supervisord conf file that starts
# containerd and buildkitd at /supervisord/supervisord.conf
mkdir -p /supervisord
nodaemon=$(if [ -z "$BACKGROUND" ]; then echo "true"; else echo "false"; fi)
cat <<EOF > /supervisord/supervisord.conf
[supervisord]
nodaemon=$nodaemon
pidfile=/tmp/supervisord.pid
logfile=/var/log/supervisord.log
[program:containerd]
command=containerd
logfile=/var/log/containerd.log
[program:buildkitd]
command=buildkitd
logfile=/var/log/buildkitd.log
EOF

# run supervisord with the conf
supervisord -c /supervisord/supervisord.conf
